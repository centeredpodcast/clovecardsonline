<!DOCTYPE html>
<html lang="en">
<head>
    <title>Clove Cards</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="keywords" content="Clove Cards, Card Game">
    <meta name="description" content="An online card game!">
    <meta name="author" content="Sapphire7x and Savanna Campbell">
</head>
<body>
    <header>
        <!--<div>
            <img>
        </div>
        <nav>
            <ul></ul>
        </nav>-->
    </header>
    <main>
        <span class="deckings" style="display: none;"></span>
        <h1>Play the Game!</h1>
        <div id="clear">
            <h2 id="cardsHeader">Cards:</h2>
            <h2 id="decksHeader">Decks:</h2>
            <button id="newDeckButton" style="display: block;">New Deck!</button>
            <span id="afterDecks" style="display: none;"></span>
        </div>
    </main>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js"></script> <!--jQuery!-->
    <script src="scripts/game.js"></script> <!--Calls game.js file-->
    <script>
        //Make it say Card Name x<however many of that card you have> (besides x1) for each card (e.g. lol x5) and split each card with a | which is unclickable.
        var strings; //define strings as a global variable.
        function showDecks(first) {
            //This function loads when the page first loads in and when you click on something that needs to reload the decks/cards!
            if(!localStorage.yourCards) {
                //If yourCards isn't in your local storage, set it!
                localStorage.setItem("yourCards", JSON.stringify(yourCards))
            } else {
                //If yourCards IS in your local storage
                if(!first) localStorage.yourCards = JSON.stringify(yourCards)
                //That only applies when you made a change to a deck/card, so update the local storage accordingly! ^^
                //If yourCards is in your storage, update yourCards to what the storage has!
                yourCards = JSON.parse(localStorage.yourCards)
            }
            if(!localStorage.activeDeck) {
                //If your active deck isn't in your local storage.
                localStorage.setItem("activeDeck", JSON.stringify(activeDeck))
            } else {
                //only applies when you made a change to a deck/card, so update the local storage accordingly!
                if(!first) localStorage.activeDeck = JSON.stringify(activeDeck)
                //If activeDeck is in your storage, update it to what the storage has.
                activeDeck = JSON.parse(localStorage.activeDeck)
            }
            if(!localStorage.decks) {
                //if decks isn't in your local storage, set it!
                localStorage.setItem("decks", JSON.stringify(decks))
            } else {
                //only applies when you made a change to a deck/card, so update the local storage accordingly!  
                if(!first) localStorage.decks = JSON.stringify(decks)
                //If decks is in the storage, update it to what the storage has.
                decks = JSON.parse(localStorage.decks)
            }
            for(l in decks) {
                //Get rid of all null values in decks!
                decks[l]=decks[l].filter(function(el) { return el; })
            }
            //clears the screen and readds the framework that should appear every time.
            $("#clear").html('<h2 id="cardsHeader">Cards:</h2><h2 id="decksHeader">Decks:</h2><button id="newDeckButton" style="display: block;">New Deck!</button><span id="afterDecks" style="display: none;"></span>') 
            var precount = 1; //this is a precount. It goes up every time you run the for loop.
            for(i in yourCards) {
                $("#cardsHeader").after("<span class='card'>" + yourCards[i] + "</span><span id='" + precount + "' style='display: none;'></span> ")
                //This shows you all of your cards and then prepares a panel that asks which deck you want it to be in.
                precount++ //increment precount.
            }
            var counter = 1; //this is like another precount just different.
            var otherCount = 1; //lol ^
            for(j in decks) { //for every deck
                $("#afterDecks").before("<h3 id='deck" + j + "' style='display: inline;'>Deck "+counter+"</h3><button class='removeDeckButton' style='display: inline;'>Delete Deck</button><span class='youSure' style='display: none;'>Are you sure? <span class='theyChoseYes'>Yes</span> | <span class='theyChoseNo'>No</span></span><div id='deck" + j + "div'></div>") //this sets the titles for each deck.
                for(k in decks[j]) { //this goes through the cards of each deck.
                    $("#deck"+j+"div").append("<span class='cardRemove "+k+"'>" + decks[j][k] + "</span><span class='deckCard' style='display: none;'>Remove from deck? <span class='yesChoice'>Yes</span> | <span class='noChoice'>No</span></span> ")
                    //This shows all the cards in that deck and prepares a panel that asks if you wish to remove it from that deck.
                    otherCount++ //increment otherCount.
                }
                counter++ //increment counter.
            }
            strings = []; //define strings as an array.
            //this is for the popup panel that shows when you click on a card to add it to a deck.
            for(k = 0; k < (counter-1); k++) {
                strings.push('<span class = "deckings">Deck ' + (Number(k) + 1) + "</span>")
                //Push a string "Deck x" for each deck.
            }

            $(".card").click(function(){ //When you click on a card...
                $(this).next()
                    .css("display", "block")
                    .html("Decks: " + strings.join(" | ") + " | <span class='close'>Close</span>")
                //Get the next element and display it. Then have it display all the decks.
                $(".close").click(function(){
                    showDecks(); //Close it and do nothing. Just reshow everything.
                })
                $(".deckings").click(function(){ //when you click on a deck to add the card to
                    let count1 = {};
                    let count2 = {};
                    //define count1 and count2, which count how many of one card do you have and in the deck you wish to add it to.
                    if($(this).html().startsWith("Deck")) {
                        //Count how many of each card are in the deck you asked for
                        decks[$(this).html().replace("Deck ", "")-1].forEach(e => count1[e] ? count1[e]++ : count1[e] = 1 );
                        yourCards.forEach(e => count2[e] ? count2[e]++ : count2[e] = 1 );
                        //count how many of each card you have
                        if(count1[$(this).parent().prev().html()]>=count2[$(this).parent().prev().html()]) {
                            //You don't have enough to add that card to that deck!
                            $(this).html("You don't have enough of this card to add it to that deck!")
                        } else{
                            //You can add that card to the deck, so add that card to the deck!
                            decks[$(this).html().replace("Deck ", "")-1].push($(this).parent().prev().html())
                            //Reshow everything!
                            showDecks()
                        }
                    } 
                }) 
            })
            //Show the deck that is active as active!
            $("#deck"+activeDeck).after($("<span class='activeDeck'> - <i>Active Deck</i></span>"))
            for(let m in decks) {
                if(m != activeDeck) { //for every deck that isn't active, add a button to make it active.
                    $("#deck"+m).after($("<button class='activeDeckButton' style='display: inline;'>Set as Active Deck</button>"))
                }
            }
            $(".activeDeckButton").click(function(){ //If you click that button to make it active...
                activeDeck = $(this).prev().attr("id").replace("deck", "") //log it as active!
                showDecks(); //and reshow it so that it will appear as active.
            })

            $(".cardRemove").click(function(){ //If you click on a card in a deck
                $(this).next()
                    .css("display", "block")
                //show the next element, which contains the choice to remove it or not.
                $(".noChoice").click(function(){ //If you clicked no, don't remove it
                    showDecks(); //just reshow everything
                }) 
                $(".yesChoice").click(function(){ //If you clicked yes, please remove it
                    decks[$(this).parent().parent().attr('id').replace("deck", "").replace("div", "")].splice($(this).parent().prev().attr("class").replace("cardRemove", "").replace(" ", ""), 1)
                    //Remove it from the array.
                    showDecks() //Reshow everything so it's removed.
                })
            })

            $("#newDeckButton").click(function(){ //When you clicked the button to make a new mdeck
                decks.push([]) //Add a blank array to decks to signify a blank deck!
                showDecks() //reshow the decks to display this new deck.
            })
            $(".removeDeckButton").click(function(){ //When you clicked the button to remove a deck.
                $(this).next().css("display", "block") //show the next element that contains a yes/no confirmation message
                $(".theyChoseYes").click(function(){ //Yes, delete this deck.
                    if(decks.length==1) { //If you only have one deck
                        $(this).parent().html("You can't delete your only deck!")
                        //You can't delete your only deck.
                    } else { //you have more than one deck so you can delete a deck.
                        //Remove that deck from the decks
                        decks.splice($(this).parent().prev().prev().prev().attr("id").replace("deck", ""), 1)
                        if($(this).parent().prev().prev().attr("class")=="activeDeck") activeDeck = 0;
                        //Set the active deck to zero if the active deck is deleted!
                        //If you remove a deck below the active deck, update the active deck so it stays with that deck!
                        if(($(this).parent().prev().prev().prev().attr("id").replace("deck", "")) < activeDeck) activeDeck--
                        showDecks() //reshow it to display.
                    }
                })
                $(".theyChoseNo").click(function(){ //No, don't delete it
                    showDecks() //reshow it to cancel.
                })
            })
        }
        showDecks(true);
        //This triggers when the page first loads. This is true so you don't update the localstorage with the preset variables.
    </script>
</body>
</html>
